<html xmlns:th="http://www.thymeleaf.org" lang="en"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head th:replace="layout :: head">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VAI TRÒ</title>
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script type="text/javascript"
	src="webjars/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="webjars/jquery/2.2.3/jquery.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		var urls = "/admin/vaitro/ #myModals";
		$('#model-body').html(event).load(urls);
		$('#bnn').on('click', function(event) {
			event.preventDefault();
			var url = $('#myModals').attr('action');
			$.ajax({
				contentType : "application/json",
				url : "/login/check",
				data : {
					url : url
				},
				dataType : "json",
				timeout : 10000,
				success : function(data) {
					if (data > 0) {
						$('#myModal').modal("show");

					} else {
						alert("Bạn không dùng được chức năng này");
						$('#myModal').modal("hide");
					}
				},
			});
		});

		$('.buttonDelete').on('click', function(event) {
			event.preventDefault();
			var url = $('#formDelete').attr('action');
			console.log(url);
			$.ajax({
				contentType : "application/json",
				url : "/login/check",
				data : {
					url : url
				},
				dataType : "json",
				success : function(data) {
					console.log(data);
					if (data > 0) {
						$('#myDelete').modal("show");
					} else {
						alert("Bạn không dùng được chức năng này");
						$('#myDelete').modal("hide");
					}
				},
			});
			$('#delRef').click(function() {
				$('#formDelete').submit();
			});
		});

		$('.edit').on('click', function(event) {
			event.preventDefault();
			$('input[name="vaitro"]').prop("checked", false);
			var uu = $(this).attr('href');
			var id = GetURLParameter(uu, 'id');
			$.ajax({
				contentType : "application/json",
				//			url: "/login/check",
				url : "/admin/vaitro/update",
				data : {
					id : id
				},
				dataType : "json",
				timeout : 10000,
				success : function(data) {

					console.log(data);
					$('#idUpdate').val(data.id);
					$('#mUpdate').val(data.mavaitro);
					$('#tUpdate').val(data.tenvaitro);
					var cns = getData(data.vaitros);
					if (cns != null) {
						$('input[name="vaitro"]').val(cns);
					}
					;
				}
			});
		});

		$('.chi').on('click', function(event) {
			event.preventDefault();
			var url = $('.chi').attr('href');
			$.ajax({
				contentType : "application/json",
				url : "/login/check",
				data : {
					url : url
				},
				dataType : "json",
				timeout : 10000,
				success : function(data) {
					if (data > 0) {
						$('#myChitiet').modal("show");
					} else {
						$('#myChitiet').modal("hide");
						alert("Bạn không dùng được chức năng này");
					}
				},
			});
		});

		$('#search').on('click', function(event) {
			event.preventDefault();
			var url = $('#dataSearch').attr('action');
			$.ajax({
				contentType : "application/json",
				url : "/login/check",
				data : {
					url : url
				},
				dataType : "json",
				timeout : 10000,
				success : function(data) {
					if (data > 0) {
						$('#search').show();
					} else {
						$('#search').hide();
						alert("Bạn không dùng được chức năng này");
					}
				},
			});
		});
	});

	function GetURLParameter(sPageURL, sParam) {
		var sURLVariable = sPageURL.split('?');
		var sParameterName = sURLVariable[1].split('=');
		if (sParameterName[0] == sParam) {
			return sParameterName[1];
		}
	}

	function getData(data) {
		if (data == "[]") {
			return null;
		} else {
			var temp = data.substring(1, data.length - 1);
			console.log(temp);
			return temp.split(", ");
		}
	}
</script>



</head>
<body class="hold-transition skin-blue fixed sidebar-mini fuelux">
	<div class="wrapper">
		<header th:replace="layout :: header"></header>
		<aside th:replace="layout :: aside"></aside>
		<div class="content-wrapper">

			<section class="content-header">
				<h1>TRANG VAI TRÒ</h1>
			</section>
			<!-- Content Header (Page header) -->
			<!-- Main content -->

			<!-- /.content -->
			<div class="container main-content form">
				<div class="row">
					<h2 class="myclass">Danh sách vai trò</h2>
					<hr>
					<a sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_STM_EMPLOYEE')"
						th:href="@{/admin/vaitro/}" class="btn btn-primary pull-left">
						<span class="glyphicon glyphicon-plus"></span>
					</a>
					<!-- <a sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_STM_EMPLOYEE')" 
					th:href="@{/admin/vaitro/delete/'+ ${vaitro.id}}" class="btn btn-primary buttonDelete">
						<i class="glyphicon glyphicon-trash"></i>
					</a> -->
					<!-- The Modal Add New-->
					


					<form th:action="@{/admin/vaitro/dataSearch}" id="dataSearch"
						class="form-inline pull-right">
						<input type="text" class="form-control" name="namevt"
							th:value="${session.NAMEVT}"
							placeholder="Tìm kiếm theo tên vai trò..."> <input
							type="text" class="form-control" name="keyvt"
							th:value="${session.KEYVT}"
							placeholder="Tìm kiếm theo mã vai trò...">
						<button type="submit" value="Search" class="btn btn-primary"
							id="search">Tìm kiếm</button>

					</form>
					<th:block th:if="${#lists.isEmpty(VAITROS.pageList)}">
						<h2>Không tìm thấy vai trò</h2>
					</th:block>



					<th:block th:unless="${#lists.isEmpty(VAITROS.pageList)}">

						<div class="row">
							<form th:action="@{/admin/vaitro/del}" id="formDelete">
								<button class="btn btn-primary buttonDelete">
									<span class="glyphicon glyphicon-trash"></span>
								</button>
								<table class="table table-bordered">
									<thead>
										<tr>
											<th>Chọn</th>
											<th>Id</th>
											<th>Mã vai trò</th>
											<th>Tên vai trò</th>
					
											<th>Xóa</th>
											<th>Sửa</th>
											<th>Xem</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="vaitro: ${VAITROS.pageList}">
											<td><input type="checkbox" id="allDelete" name="lvt"
												th:value="${vaitro.id}" /></td>
											<td th:text="${vaitro.id}"></td>
											<td th:text="${vaitro.mavaitro}"></td>
											<td th:text="${vaitro.tenvaitro}"></td>
						

											<!-- class="btn btn-primary edit" -->
											<td
												sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_STM_EMPLOYEE')"><a
												th:href="@{'/admin/vaitro/delete/' + ${vaitro.id}}"><span
													class="glyphicon glyphicon-trash"></span></a></td>
											<!-- <td
												sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_STM_EMPLOYEE')"><a
												th:href="@{/admin/vaitro/update/(id=${vaitro.id})}" 
												data-toggle="modal" data-target="#myEdit"><span
													class="glyphicon glyphicon-pencil"></span></a></td> -->
											<td sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_STM_EMPLOYEE')"><a
											th:href="@{'/admin/vaitro/edit/' + ${vaitro.id}}"><span
												class="glyphicon glyphicon-pencil"></span></a></td>
											<td><a th:href="@{/admin/vaitro/vaitro-chitiet/}"
												data-toggle="modal" data-target="#myChitiet"
												th:attrappend="data-target=${vaitro.id}"><span
													class="glyphicon glyphicon-eye-open"></span> <!-- <i
													class="fas fa-eye"></i> --></a> <!-- The Modal Chi tiet -->
												<div class="modal" id="myChitiet"
													th:attrappend="id=${vaitro.id}">
													<div class="modal-dialog">
														<div class="modal-content chitiet">

															<!-- Modal Header -->
															<div class="modal-header">
																<h4>Chi tiết</h4>
																<button type="button" class="close" data-dismiss="modal">&times;</button>
															</div>
															<div id="chitiet-body">
																<table class="table table-bordered">
																	<tr>
																		<th>Id</th>
																		<td th:text="${vaitro.id}"></td>
																	</tr>
																	<tr>
																		<th>Mã vai trò</th>
																		<td th:text="${vaitro.mavaitro}"></td>
																	</tr>
																	<tr>
																		<th>Tên vai trò</th>
																		<td th:text="${vaitro.tenvaitro}"></td>
																	</tr>
																	<tr>
																		<th>Ngày tạo</th>
																		<td th:text="${vaitro.createday}"></td>
																	</tr>
																	<tr>
																		<th>Người tạo</th>
																		<td th:text="${vaitro.nguoitao}"></td>
																	</tr>
																	<tr>
																		<th>Ngày Cập Nhật</th>
																		<td th:text="${vaitro.updateday}"></td>
																	</tr>
																	<tr>
																		<th>Người Cập Nhật</th>
																		<td th:text="${vaitro.nguoiupdate}"></td>
																	</tr>
																	<tr>
																			<th>Quyền hạn</th>
																			<td>
																				<ul th:each="cn : ${vaitro.chucnang}">
																					<li th:text="${cn.tenchucnang}"></li>
																				</ul>
																			</td>
																		</tr>
																
																</table>
															</div>
															<div class="modal-footer"></div>
														</div>
													</div>
												</div></td>

										</tr>
									</tbody>
								</table>
							</form>
						</div>

						<p class="showcount" th:text="'Số lượng: ' + ${sum}"></p>
						<p class="showin"
							th:text="'Trang '+ ${pageNumber} + ' trong tổng số ' + ${totalPageCount} + ' trang' "></p>

						<!-- phan trang-->
						<ul class="pagination">
							<li
								th:class="${currentIndex == 1} ? 'page-item disabled' : 'page-item'">
								<a class="page-link" th:href="@{/vaitro/list}">Đầu</a>
							</li>
							<li
								th:class="${currentIndex == 1} ? 'page-item disabled' : 'page-item'">
								<a class="page-link" aria-label="Previous"
								th:href="@{|${baseUrl}${currentIndex - 1}|}"
								title='Go to previous page'> <span aria-hidden="true"><<</span>
									<span class="sr-only">Lùi</span></a>
							</li>
							<li th:each="item: ${#numbers.sequence(beginIndex, endIndex)}"
								th:class="${item == currentIndex ? 'page-item active' : 'page-item'}">
								<a class="page-link" th:href="@{|${baseUrl}${item}|}"> <span
									th:text='${item}'>1</span>
							</a>
							</li>
							<li
								th:class="${currentIndex == totalPageCount} ? 'page-item disabled' : 'page-item'">
								<a class="page-link" aria-label="Next"
								th:href="@{|${baseUrl}${currentIndex + 1}|}"
								title='Go to next page'> <span aria-hidden="true">>></span>
									<span class="sr-only">Tiến</span></a>
							</li>
							<li
								th:class="${currentIndex == totalPageCount} ? 'page-item disabled' : 'page-item'">
								<a class="page-link" th:href="@{|${baseUrl}${totalPageCount}|}">Cuối</a>
							</li>
						</ul>

					</th:block>
					<!-- The Modal Edit -->
			<!-- <div class="modal" id="myEdit">
				<div class="modal-dialog">
					<div class="modal-content">

						Modal Header
						<div class="modal-header">
							<h4>Cập nhật vai trò</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>
						<div id="edit-body">
							<form th:action="@{/admin/vaitro/updateVaiTro}" method="put"
								id="formEdit">
								<input type="hidden" name="id" id="idUpdate">
								<div class="form-group">
									<label class="col-sm-2 col-form-label">Mã Vai Trò(*)</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" name="mavaitro"
											id="mUpdate">
									</div>

								</div>
								<div class="form-group ">
									<label class="col-sm-2 col-form-label">Tên Vai Trò(*)</label>
									<div class="col-sm-10">
										<input type="text" class="form-control" name="tenvaitro"
											id="tUpdate">
									</div>

								</div>
								<div class="form-group ">
									<label class="col-sm-2 col-form-label">Chức Năng</label>
									<div class="col-sm-10">
										<table class="table table-bordered">
											<thead>
												<tr>
													<th>Chọn</th>
													<th>Tên chức năng</th>
												</tr>
											</thead>
											<tbody>
												<tr th:each="chucnang: ${CHUCNANGS}">
													<td><input class="vt-update" type="checkbox"
														name="chucnang" th:value="${chucnang.id}"></td>
													<td th:text="${chucnang.tenchucnang}"></td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
								<button type="submit" id="toggler" class="btn btn-primary them">Cập
									nhật</button>
							</form>
						</div>
						<div class="modal-footer"></div>
					</div>
				</div>
			</div> -->

					<!-- The Modal Delete -->
					<div class="modal" tabindex="-1" role="dialog" id="myDelete">
						<div class="modal-dialog">
							<div class="modal-content">

								<!-- Modal Header -->
								<div class="modal-header">

									<button type="button" class="close" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div id="delete-body">
									<h4>Bạn có chắc chắn răng muốn xóa thông tin này?</h4>


								</div>
								<div class="modal-footer">
									<button type="button" id="delRef" class="btn btn-primary ">Đúng,
										Xóa thông tin này</button>
									<button type="button" class="btn btn-danger"
										data-dismiss="modal">Đóng</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<script th:inline="javascript">
			var message = /*[[${CHUCNANGS}]]*/'default';
			console.log('mesage', message);
			(function(cns){
				let map = {};
				console.log('debug');
				let rs = cns.reduce((map,item)=>{
				    let {mapv, cns} = map;
				    cns[item.id] = item;
				    if(!mapv[item.parentid]){mapv[item.parentid] = []};
				    mapv[item.parentid].push(item);
				    return map;
				}, {cns: {}, mapv: {}})
				let tableBody = $('.view-per');
				tableBody.html('');
				for(let key in rs.mapv){
				    let parent = rs.cns[key];
				    if(parent){
				        let parentJDOM;
				        tableBody.append(parentJDOM = $(`<tr is-hide="1">
				            <td><input type="checkbox" class="cb-per" value="${parent.id}" name="chucnang"/></td>
				            <td>${parent.tenchucnang}</td>
				        </tr>`).click((evt)=>{
				    let target = $(evt.currentTarget);
				    let checkbox = $('td > input.cb-per' ,target);
				    if(evt.target !== checkbox[0]){
				if(target.attr('is-hide')){
				        target.removeAttr('is-hide');
				        $('.view-per > tr.child-'+key).removeClass('d-none')
				    }else{
				 target.attr('is-hide', '1');
				        $('.view-per > tr.child-'+key).addClass('d-none')
				    }
				}
				    
				}))
				$('td > input.cb-per' ,parentJDOM).change((evt)=>{
				let check = false;
				let childs =  $('.view-per > tr.child-'+key);
				if(evt.currentTarget.checked){
				    //xổ ra nếu checkbox true
				    parentJDOM.removeAttr('is-hide');
				        childs.removeClass('d-none');
				    check = true;
				}
				childs.each((index, element)=>{
				    $('td > input.cb-per', element)[0].checked = check
				})
				})
				        let childs = rs.mapv[key];
				        if(childs){
				        for(let child of childs){
				tableBody.append($(`<tr class="child-${key} d-none">
				            <td><input type="checkbox" class="cb-per" value="${child.id}" name="chucnang"/></td>
				            <td>${child.tenchucnang}</td>
				        </tr>`))
				        }
				    }
				}
				}
				})(message)
		</script>
			</div>

		</div>
		
	</div>
	<footer th:replace="layout :: footer"></footer>
</body>


</html>