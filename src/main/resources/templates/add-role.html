<html xmlns:th="http://www.thymeleaf.org" lang="en"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head th:replace="layout :: head">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VAI TRÒ</title>
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script type="text/javascript"
	src="webjars/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="webjars/jquery/2.2.3/jquery.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		var url = $('#myModals').attr('action');
		$.ajax({
			contentType : "application/json",
			url : "/login/check",
			data : {
				url : url
			},
			dataType : "json",
			timeout : 10000,
			success : function(data) {
				if (data > 0) {
					$('.them').show();
				} else {
					$('.them').hide();
					alert("Bạn không dùng được chức năng này");
				}
			},
		});

		var href = $('.sach').attr('href');
		$.ajax({
			contentType : "application/json",
			url : "/login/check",
			data : {
				url : url
			},
			dataType : "json",
			timeout : 10000,
			success : function(data) {
				if (data > 0) {
					$('.sach').show();
				} else {
					$('.sach').hide();
					alert("Bạn không dùng được chức năng này");
				}
			},
		});
	});

	$('.-1').on('click', function() {
		var obj = $(this);
		if (obj.hasClass('-1')) {
			obj.hide();
			obj.next().show();
			obj.parent().parent().next().show();
		} else {
			obj.hide();
			obj.prev().show();
			obj.parent().parent().next().hide();
		}
	})
</script>



</head>
<body class="hold-transition skin-blue fixed sidebar-mini fuelux">
	<div class="wrapper">
		<header th:replace="layout :: header"></header>
		<aside th:replace="layout :: aside"></aside>
		<div class="content-wrapper">

			<section class="content-header">
				<h1>TRANG VAI TRÒ</h1>
			</section>
			<!-- Content Header (Page header) -->
			<!-- Main content -->

			<!-- /.content -->
			<div class="container main-content form">
				<div class="row">
					<!-- <h2 class="myclass">Thêm chức năng</h2> -->
					<form th:action="@{/admin/vaitro/saveVaitro}" th:object="${VAITRO}"
						id="myModals">
						<div class="">
							<div class="">
								<div class="modal-header">
									<h2 class="modal-title" id="exampleModalLabel">Thêm vai
										trò</h2>
									<button type="button" class="close" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">

									<input type="hidden" th:field="*{id}" name="id">

									<div class="form-group">
										<label for="recipient-name" class="col-form-label">Mã
											Vai Trò(*):</label> <input type="text" class="form-control"
											placeholder="Nhập mã vai trò" th:field="*{mavaitro}">
									</div>

									<div class="form-group">
										<label for="recipient-name" class="col-form-label">Tên
											Vai Trò(*)</label> <input type="text" class="form-control"
											placeholder="Nhập tên vai trò" th:field="*{tenvaitro}">
									</div>

									<div class="form-group">
										<label class="col-sm-2 col-form-label">Chức Năng</label>
										<div class="col-sm-10">
											<table class="table table-bordered">
												<thead>
													<tr>
														<th>Chọn</th>
														<th>Tên chức năng</th>
													</tr>
												</thead>
												<tbody class="view-per">
													<!-- <tr th:each="chucnang: ${CHUCNANGS}">
											<td><input type="checkbox" 
												th:value="${chucnang.id}" /></td>
											<td th:text="${chucnang.tenchucnang}"></td> -->
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button type="submit" class="btn btn-primary">Thêm mới</button>
									<button type="reset" class="btn btn-primary">Huỷ</button>
									<a href="/admin/vaitro/list/" class="btn btn-primary">Xem
										danh sách</a>
								</div>
							</div>
						</div>
					</form>
				</div>
				<script th:inline="javascript">
			var message = /*[[${CHUCNANGS}]]*/'default';
			console.log('mesage', message);
			(function(cns){
				let map = {};
				console.log('debug');
				let rs = cns.reduce((map,item)=>{
				    let {mapv, cns} = map;
				    cns[item.id] = item;
				    if(!mapv[item.parentid]){mapv[item.parentid] = []};
				    mapv[item.parentid].push(item);
				    return map;
				}, {cns: {}, mapv: {}})
				let tableBody = $('.view-per');
				tableBody.html('');
				for(let key in rs.mapv){
				    let parent = rs.cns[key];
				    if(parent){
				        let parentJDOM;
				        tableBody.append(parentJDOM = $(`<tr is-hide="1">
				            <td><input type="checkbox" class="cb-per" value="${parent.id}" name="chucnang"/></td>
				            <td>${parent.tenchucnang}</td>
				        </tr>`).click((evt)=>{
				    let target = $(evt.currentTarget);
				    let checkbox = $('td > input.cb-per' ,target);
				    if(evt.target !== checkbox[0]){
				if(target.attr('is-hide')){
				        target.removeAttr('is-hide');
				        $('.view-per > tr.child-'+key).removeClass('d-none')
				    }else{
				 target.attr('is-hide', '1');
				        $('.view-per > tr.child-'+key).addClass('d-none')
				    }
				}
				    
				}))
				$('td > input.cb-per' ,parentJDOM).change((evt)=>{
				let check = false;
				let childs =  $('.view-per > tr.child-'+key);
				if(evt.currentTarget.checked){
				    //xổ ra nếu checkbox true
				    parentJDOM.removeAttr('is-hide');
				        childs.removeClass('d-none');
				    check = true;
				}
				childs.each((index, element)=>{
				    $('td > input.cb-per', element)[0].checked = check
				})
				})
				        let childs = rs.mapv[key];
				        if(childs){
				        for(let child of childs){
				tableBody.append($(`<tr class="child-${key} d-none">
				            <td><input type="checkbox" class="cb-per" value="${child.id}" name="chucnang"/></td>
				            <td>${child.tenchucnang}</td>
				        </tr>`))
				        }
				    }
				}
				}
				})(message)
		</script>
			</div>

		</div>
	</div>
	<footer th:replace="layout :: footer"></footer>
</body>


</html>